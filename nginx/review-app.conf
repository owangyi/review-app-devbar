# ============================================================
# 说明
# ============================================================
# 
# Nginx 配置很简单，只做域名到目录的映射：
# - *.discovery.wang → /srv/nginx/pages/{branch}/public
# - *.api.discovery.wang → /srv/nginx/pages/{branch}/api/public
#
# Cookie 逻辑在前端 JS 中处理：
# - DevBar 组件读取 Cookie，决定跳转到哪个域名
# - apiClient 读取 Cookie，决定请求哪个 API 域名
#
# ============================================================

# 工作流程：
# 1. 前端：Cookie (x_target_frontend) → 跳转到新域名 → Nginx 根据域名路由
# 2. 后端：Cookie (x_target_backend) → 构造 API URL → Nginx 根据域名路由
# 
# 部署结构：
# /srv/nginx/pages/
# ├── develop/
# │   ├── public/              # develop.discovery.wang
# │   └── api/public/          # develop.api.discovery.wang
# ├── feature-dev-001/
# │   ├── public/              # feature-dev-001.discovery.wang
# │   └── api/public/          # feature-dev-001.api.discovery.wang
# └── shared/dev-ops/          # DevBar API（共享）
#
# ============================================================
# Server Block 1: 前端静态资源
# 域名模式: *.discovery.wang (如 feature-dev-002.discovery.wang)
# ============================================================
server {
    listen 80;
    server_name ~^(?<branch>[^.]+)\.discovery\.wang$;
    
    # 直接根据域名中的分支名路由
    root /srv/nginx/pages/$branch/public;
    index index.html index.htm index.php;
    charset utf-8;

    # 禁用 HTML 缓存，确保切换分支生效
    add_header Cache-Control "no-cache, no-store, must-revalidate" always;
    add_header Pragma "no-cache" always;
    add_header Expires "0" always;

    # 安全头
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;

    # DevBar API 端点（共享，所有分支使用同一个）
    location /dev-ops/ {
        alias /srv/nginx/shared/dev-ops/;
        
        location ~ \.php$ {
            fastcgi_pass php-fpm:9000;
            fastcgi_index environments.php;
            # 使用 $request_filename 而不是 $fastcgi_script_name，因为我们使用了 alias
            fastcgi_param SCRIPT_FILENAME $request_filename;
            include fastcgi_params;
            fastcgi_read_timeout 300;
        }
    }

    # 前端静态资源
    location / {
        try_files $uri $uri/ /index.html;
    }

    # PHP 文件处理（如果前端需要）
    location ~ \.php$ {
        fastcgi_pass php-fpm:9000;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
        fastcgi_read_timeout 300;
    }

    # 静态文件缓存（CSS, JS, 图片等）
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # 重置环境 Cookie（辅助功能）
    location /reset-env {
        add_header Set-Cookie "x_target_frontend=; path=/; max-age=0" always;
        add_header Set-Cookie "x_target_backend=; path=/; max-age=0" always;
        return 302 $scheme://$http_host/;
    }

    access_log /var/log/nginx/$branch-frontend.log;
    error_log /var/log/nginx/frontend-error.log warn;
}

# ============================================================
# Server Block 2: 后端 API 服务
# 域名模式: *.api.discovery.wang (如 feature-dev-001.api.discovery.wang)
# ============================================================
server {
    listen 80;
    server_name ~^(?<api_branch>[^.]+)\.api\.discovery\.wang$;

    # 直接根据域名中的分支名路由
    root /srv/nginx/pages/$api_branch/api/public;
    index index.php index.html index.json;
    charset utf-8;

    # CORS 配置（允许来自所有 *.discovery.wang 的请求）
    add_header Access-Control-Allow-Origin $http_origin always;
    add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, PATCH, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, X-CSRF-Token" always;
    add_header Access-Control-Allow-Credentials "true" always;

    # CORS 预检请求处理
    location @options {
        add_header Access-Control-Allow-Origin $http_origin always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, PATCH, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, X-CSRF-Token" always;
        add_header Access-Control-Allow-Credentials "true" always;
        add_header Access-Control-Max-Age 3600 always;
        add_header Content-Length 0;
        add_header Content-Type text/plain;
        return 204;
    }

    # API 路由
    location / {
        # 处理 OPTIONS 预检请求
        if ($request_method = 'OPTIONS') {
            add_header Access-Control-Allow-Origin $http_origin always;
            add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, PATCH, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, X-CSRF-Token" always;
            add_header Access-Control-Allow-Credentials "true" always;
            add_header Access-Control-Max-Age 3600 always;
            add_header Content-Length 0;
            add_header Content-Type text/plain;
            return 204;
        }
        
        try_files $uri $uri/ /index.php?$query_string;
    }

    # PHP 处理（如果是 PHP 后端）
    location ~ \.php$ {
        # 处理 OPTIONS 预检请求（必须在 fastcgi_pass 之前）
        if ($request_method = 'OPTIONS') {
            add_header Access-Control-Allow-Origin $http_origin always;
            add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, PATCH, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, X-CSRF-Token" always;
            add_header Access-Control-Allow-Credentials "true" always;
            add_header Access-Control-Max-Age 3600 always;
            add_header Content-Length 0;
            add_header Content-Type text/plain;
            return 204;
        }
        
        fastcgi_pass php-fpm:9000;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
        
        # 安全设置
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_param PATH_INFO $fastcgi_path_info;
        fastcgi_param PATH_TRANSLATED $document_root$fastcgi_path_info;
        
        # 超时设置
        fastcgi_read_timeout 300;
    }

    # JSON 文件（如果是静态 JSON API）
    location ~ \.json$ {
        add_header Content-Type application/json;
        try_files $uri =404;
    }

    # 健康检查端点
    location = /health {
        access_log off;
        return 200 "OK\n";
        add_header Content-Type text/plain;
    }

    access_log /var/log/nginx/$api_branch-backend.log;
    error_log /var/log/nginx/backend-error.log warn;
}

# ============================================================
# Fallback: 主域名
# ============================================================
server {
    listen 80 default_server;
    server_name discovery.wang www.discovery.wang;
    
    root /srv/nginx/pages/develop/public;
    index index.html index.htm;
    
    location / {
        try_files $uri $uri/ /index.html;
    }
}